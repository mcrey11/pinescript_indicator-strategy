//@version=5
strategy("MACD Momentum â€” Conservative (Variant 5) â€” PineConnector-ready (fixed)", 
     overlay=true, margin_long=100, margin_short=100, initial_capital=10000, 
     commission_type=strategy.commission.percent, commission_value=0.02, calc_on_every_tick=false)

// =====================
// === USER INPUTS ====
// =====================
// MACD & Trend
fastLength    = input.int(12, "MACD Fast EMA", minval=1)
slowLength    = input.int(26, "MACD Slow EMA", minval=1)
signalLength  = input.int(6,  "MACD Signal EMA", minval=1)
emaLength     = input.int(50, "Trend EMA Length", minval=1)
strengthLevel = input.float(1.5, "MACD Strength Filter", step=0.1)
useFilter     = input.bool(true, "Use MACD Strength Filter?")

// Volatility
useVolatility = input.bool(false, "Enable Volatility Filter?")
atrLength     = input.int(14, "ATR Length", minval=1)
atrMult       = input.float(0.5, "ATR Threshold Multiplier", step=0.1)

// Session Filter
useSessionFilter = input.bool(false, "Enable Session Filter?")
sessionTime      = input.session("0000-2359", "Active Session (Broker Time)")

// Risk / Stops
useStops          = input.bool(true, "Enable Stop-Loss / Take-Profit?")
stopType          = input.string("Percent", "Stop Type", options=["Percent", "Profit/Loss"])
stopLossValue     = input.float(1.0, "Stop Loss (%) or P/L", step=0.1)
takeProfitValue   = input.float(2.0, "Take Profit (%) or P/L", step=0.1)
useTrailingStop   = input.bool(true, "Enable Trailing Stop?")
trailPercent      = input.float(0.8, "Trailing Stop (%)", step=0.1)
bufferTicks       = input.int(2, "Stop buffer (ticks)", minval=0)  // small buffer to avoid immediate hit

// Orders / Webhook / PineConnector specifics
orderSize         = input.float(0.1, "Order Size (lots/contracts)", step=0.01)
sendAlertsFromScript = input.bool(true, "Send alert() from script? (create a TradingView alert for 'Any alert() function call')")
connectorFormat   = input.string("PineConnector CSV", "Webhook format", options=["PineConnector CSV", "JSON (custom)"])
pine_license_id   = input.string("", "PineConnector License ID (if applicable)")

// Debug / visual helpers
showChecks = input.bool(true, "Show condition checks on chart?")

// =====================
// === INDICATORS =====
// =====================
[macdLine, signalLine, histLine] = ta.macd(close, fastLength, slowLength, signalLength)
emaTrend = ta.ema(close, emaLength)

// =====================
// === FILTERS =========
// =====================
bullTrend = close > emaTrend
bearTrend = close < emaTrend

atrValue = ta.atr(atrLength)
atrThreshold = ta.sma(atrValue, 50) * atrMult
highVolatility = atrValue > atrThreshold

inSession = (not useSessionFilter) or (time(timeframe.period, sessionTime) != na)
validMarket = (not useVolatility or highVolatility) and inSession

// =====================
// === VARIANT 5: CONSERVATIVE ENTRY LOGIC ===
// Conservative: combine momentum + candle + volume + one-bar confirmation

// 1) Momentum confirmation: histogram on the correct side and rising/falling
histRising  = histLine > 0 and ta.change(histLine) > 0
histFalling = histLine < 0 and ta.change(histLine) < 0

// 2) Volume confirmation
volSMA = ta.sma(volume, 20)
volOk = volume > volSMA

// 3) One-bar confirmation for MACD crossover/crossunder (happened last bar)
crossover_onebar = (macdLine[1] > signalLine[1]) and (macdLine[2] <= signalLine[2])
crossunder_onebar = (macdLine[1] < signalLine[1]) and (macdLine[2] >= signalLine[2])

// 4) Candle confirmation: bullish/bearish confirming candle (close > open and above EMA, etc.)
confirmBull = (close > open) and (close > emaTrend) and (close > high[1])
confirmBear = (close < open) and (close < emaTrend) and (close < low[1])

// 5) Strength filter (optional)
strengthPassBuy  = (not useFilter) or (macdLine > strengthLevel)
strengthPassSell = (not useFilter) or (macdLine < -strengthLevel)

// Compose final conservative conditions
buyCond  = crossover_onebar and histRising and volOk and confirmBull and strengthPassBuy and validMarket
sellCond = crossunder_onebar and histFalling and volOk and confirmBear and strengthPassSell and validMarket

// =====================
// === HELPERS / PAYLOADS ===
tick = syminfo.mintick
buf = bufferTicks * tick
symbol_out = syminfo.ticker

f_format_price(_p) =>
    str.tostring(_p, format.mintick)

// current bar-close entry price (used for alert payloads)
entryPrice_now = close

// compute percent-based SL/TP at current price (used for the alert payload)
sl_price_long_now = entryPrice_now * (1 - stopLossValue / 100) - buf
tp_price_long_now = entryPrice_now * (1 + takeProfitValue / 100)
sl_price_short_now = entryPrice_now * (1 + stopLossValue / 100) + buf
tp_price_short_now = entryPrice_now * (1 - takeProfitValue / 100)

trailPoints_long_now = useTrailingStop ? (entryPrice_now * (trailPercent / 100)) : na
trailPoints_short_now = useTrailingStop ? (entryPrice_now * (trailPercent / 100)) : na

// Build PineConnector CSV & JSON payloads
f_null_or_price(_p) =>
    na(_p) ? "NULL" : f_format_price(_p)

pine_csv_buy = pine_license_id + "," + "BUY" + "," + symbol_out + "," + str.tostring(orderSize, format.mintick) + "," + f_null_or_price(sl_price_long_now) + "," + f_null_or_price(tp_price_long_now) + "," + "auto"
pine_csv_sell = pine_license_id + "," + "SELL" + "," + symbol_out + "," + str.tostring(orderSize, format.mintick) + "," + f_null_or_price(sl_price_short_now) + "," + f_null_or_price(tp_price_short_now) + "," + "auto"

json_buy = '{' +
  '"action":"BUY",' +
  '"symbol":"' + symbol_out + '",' +
  '"size":' + str.tostring(orderSize, format.mintick) + ',' +
  '"entry_price":' + f_format_price(entryPrice_now) + ',' +
  '"sl_pct":' + str.tostring(stopLossValue) + ',' +
  '"tp_pct":' + str.tostring(takeProfitValue) + ',' +
  '"sl_price":' + f_format_price(sl_price_long_now) + ',' +
  '"tp_price":' + f_format_price(tp_price_long_now) +
  '}'

json_sell = '{' +
  '"action":"SELL",' +
  '"symbol":"' + symbol_out + '",' +
  '"size":' + str.tostring(orderSize, format.mintick) + ',' +
  '"entry_price":' + f_format_price(entryPrice_now) + ',' +
  '"sl_pct":' + str.tostring(stopLossValue) + ',' +
  '"tp_pct":' + str.tostring(takeProfitValue) + ',' +
  '"sl_price":' + f_format_price(sl_price_short_now) + ',' +
  '"tp_price":' + f_format_price(tp_price_short_now) +
  '}'

payload_buy  = connectorFormat == "PineConnector CSV" ? pine_csv_buy : json_buy
payload_sell = connectorFormat == "PineConnector CSV" ? pine_csv_sell : json_sell

// =====================
// === PLOTTING CHECKS (TOP-LEVEL) ===
// plotshape must be declared at top-level. Gate drawing with showChecks.
plotshape(showChecks and crossover_onebar, title="MACD xbar",    location=location.belowbar, color=color.yellow, style=shape.circle,     size=size.tiny)
plotshape(showChecks and histRising,       title="Hist Rising", location=location.belowbar, color=color.green,  style=shape.square,     size=size.tiny)
plotshape(showChecks and volOk,            title="Vol OK",      location=location.belowbar, color=color.blue,   style=shape.cross,      size=size.tiny)
plotshape(showChecks and confirmBull,      title="Candle OK",   location=location.belowbar, color=color.aqua,   style=shape.triangleup, size=size.tiny)

// =====================
// === ALERTCONDITIONS ===
// Use constant messages for alertcondition. For dynamic payloads, use alert(...)
alertcondition(true and buyCond and strategy.position_size == 0, title="Buy Signal (const)", message="PINE_BUY")
alertcondition(true and sellCond and strategy.position_size == 0, title="Sell Signal (const)", message="PINE_SELL")

// =====================
// === ENTRY EXECUTION & ALERTS ===
// =====================
// persistent flag to avoid duplicate sends until position lifecycle completes
var string lastSignalSent = "NONE"

if (buyCond and strategy.position_size == 0 and lastSignalSent != "BUY")
    // place paper/backtest trade and send webhook
    strategy.entry("LONG_ENTRY", strategy.long, qty = orderSize)
    if sendAlertsFromScript
        alert(payload_buy, alert.freq_once_per_bar_close)
    lastSignalSent := "BUY"

if (sellCond and strategy.position_size == 0 and lastSignalSent != "SELL")
    strategy.entry("SHORT_ENTRY", strategy.short, qty = orderSize)
    if sendAlertsFromScript
        alert(payload_sell, alert.freq_once_per_bar_close)
    lastSignalSent := "SELL"

// reset after position closed so same-side signals can re-fire later
if (strategy.position_size == 0)
    lastSignalSent := "NONE"

// =====================
// === EXIT PROCESS ====
// =====================
var float longStop   = na
var float longTP     = na
var float shortStop  = na
var float shortTP    = na
var float trailPointsLong = na
var float trailPointsShort = na

if useStops and stopType == "Percent"
    if strategy.position_size > 0
        entryPrice = strategy.position_avg_price
        longStop := entryPrice * (1 - stopLossValue / 100) - buf
        longTP   := entryPrice * (1 + takeProfitValue / 100)
        trailPointsLong := useTrailingStop ? (entryPrice * (trailPercent / 100)) : na
    else
        longStop := na
        longTP := na
        trailPointsLong := na

    if strategy.position_size < 0
        entryPrice = strategy.position_avg_price
        shortStop := entryPrice * (1 + stopLossValue / 100) + buf
        shortTP   := entryPrice * (1 - takeProfitValue / 100)
        trailPointsShort := useTrailingStop ? (entryPrice * (trailPercent / 100)) : na
    else
        shortStop := na
        shortTP := na
        trailPointsShort := na
else
    longStop := na
    longTP := na
    shortStop := na
    shortTP := na
    trailPointsLong := na
    trailPointsShort := na

if strategy.position_size > 0
    if useStops and stopType == "Percent"
        if not na(trailPointsLong)
            strategy.exit(id="LONG_EXIT", from_entry="LONG_ENTRY", stop=longStop, limit=longTP, trail_points=trailPointsLong)
        else
            strategy.exit(id="LONG_EXIT", from_entry="LONG_ENTRY", stop=longStop, limit=longTP)

if strategy.position_size < 0
    if useStops and stopType == "Percent"
        if not na(trailPointsShort)
            strategy.exit(id="SHORT_EXIT", from_entry="SHORT_ENTRY", stop=shortStop, limit=shortTP, trail_points=trailPointsShort)
        else
            strategy.exit(id="SHORT_EXIT", from_entry="SHORT_ENTRY", stop=shortStop, limit=shortTP)

// =====================
// === VISUALS / DEBUG ===
plot(emaTrend, title="EMA Trend", color=color.orange)
plotshape(buyCond, title="Buy Marker", style=shape.triangleup, location=location.belowbar, color=color.lime, size=size.small)
plotshape(sellCond, title="Sell Marker", style=shape.triangledown, location=location.abovebar, color=color.red, size=size.small)

var table infoBox = table.new(position.top_right, 1, 8)
table.clear(infoBox, 0, 0, 0, 7)
trendText  = bullTrend ? "BULLISH" : bearTrend ? "BEARISH" : "NEUTRAL"
trendColor = bullTrend ? color.new(color.green, 0) : bearTrend ? color.new(color.red, 0) : color.new(color.gray, 0)
posSize = strategy.position_size
posPL   = strategy.openprofit
float plPct = na
if strategy.position_size != 0 and strategy.position_avg_price != 0
    plPct := posPL / (strategy.position_avg_price * math.abs(strategy.position_size)) * 100
else
    plPct := 0.0
string plText = posSize == 0 ? "0" : (str.tostring(posPL, format.mintick) + " (" + str.tostring(plPct, format.percent) + ")")
color plColor = posPL > 0 ? color.new(color.green, 0) : posPL < 0 ? color.new(color.red, 0) : color.new(color.gray, 0)
posDir  = posSize > 0 ? "LONG" : posSize < 0 ? "SHORT" : "NONE"
stopsStatus = useStops ? (useTrailingStop ? "Trailing ON" : "Fixed ON") : "Disabled"

table.cell(infoBox, 0, 0, "ðŸ“Š  MACD Momentum (Variant 5)", text_color=color.yellow, bgcolor=color.new(color.black, 80))
table.cell(infoBox, 0, 1, "Trend: " + trendText, text_color=color.white, bgcolor=trendColor)
table.cell(infoBox, 0, 2, "BuyCond: " + (buyCond ? "YES" : "NO"), text_color=color.white, bgcolor=color.new(color.blue, 60))
table.cell(infoBox, 0, 3, "Hist/Vol/Candle: " + (histRising ? "H" : "-") + "/" + (volOk ? "V" : "-") + "/" + (confirmBull ? "C" : "-"), text_color=color.white, bgcolor=color.new(color.gray, 70))
table.cell(infoBox, 0, 4, "Last Signal: " + lastSignalSent, text_color=color.white, bgcolor=color.new(color.black, 60))
table.cell(infoBox, 0, 5, "Position: " + posDir, text_color=color.white, bgcolor=color.new(color.gray, 70))
table.cell(infoBox, 0, 6, "P/L: " + plText, text_color=color.white, bgcolor=plColor)
table.cell(infoBox, 0, 7, "Payload Example: " + (connectorFormat == "PineConnector CSV" ? pine_csv_buy : json_buy), text_color=color.white, bgcolor=color.new(color.black, 60))